module complex_bessel

  private
  public :: cjy

contains

  SUBROUTINE cjy(v,z,cbjv,cbyv)

    !       ===================================================
    !       Purpose: Compute Bessel functions Jv(z) and Yv(z)
    !                and their derivatives with a complex
    !                argument and a large order
    !       Input:   v --- Order of Jv(z) and Yv(z)
    !                z --- Complex argument
    !       Output:  CBJV --- Jv(z)
    !                CBYV --- Yv(z)
    !       ===================================================
    use constants, only : EP,PIEP
    implicit none

    REAL(EP), INTENT(IN)  :: v
    COMPLEX(EP), INTENT(IN)   :: z
    COMPLEX(EP), INTENT(OUT)  :: cbjv
    COMPLEX(EP), INTENT(OUT)  :: cbyv

    real(EP), dimension(91) :: a
    complex(EP), dimension(12) :: cf

    integer :: i,l,k,km,l0,lf
    complex(EP) :: cws,ceta,ct,ct2,csj,csy,cfj,cfy
    real(EP) :: v0,vr

    a = [1.00000000000000000000000000000000000, & 
        & 0.125000000000000000000000000000000000, & 
        & -0.208333333333333333333333333333333341, & 
        & 7.03125000000000000000000000000000000E-0002, & 
        & -0.401041666666666666666666666666666683, & 
        & 0.334201388888888888888888888888888894, & 
        & 7.32421875000000000000000000000000000E-0002, & 
        & -0.891210937500000000000000000000000019, & 
        & 1.84646267361111111111111111111111115, & 
        & -1.02581259645061728395061728395061744, & 
        & 0.112152099609375000000000000000000000, & 
        & -2.36408691406250000000000000000000023, & 
        & 8.78912353515625000000000000000000000, & 
        & -11.2070026162229938271604938271604949, & 
        & 4.66958442342624742798353909465020581, & 
        & 0.227108001708984375000000000000000000, & 
        & -7.36879435947963169642857142857142895, & 
        & 42.5349987453884548611111111111111188, & 
        & -91.8182415432400173611111111111111139, & 
        & 84.6362176746007346322016460905349880, & 
        & -28.2120725582002448774005486968449940, & 
        & 0.572501420974731445312500000000000000, & 
        & -26.4914304869515555245535714285714303, & 
        & 218.190511744211590479290674603174653, & 
        & -699.579627376132541232638888888888970, & 
        & 1059.99045252799987792968750000000000, & 
        & -765.252468141181642299489883401920485, & 
        & 212.570130039217122860969412056089015, & 
        & 1.72772750258445739746093750000000000, & 
        & -108.090919788394655500139508928571443, & 
        & 1200.90291321635246276855468750000027, & 
        & -5305.64697861340310838487413194444593, & 
        & 11655.3933368645332477710865162037032, & 
        & -13586.5500064341374385504075038580258, & 
        & 8061.72218173730938450226495222717585, & 
        & -1919.45766231840699631006308386361335, & 
        & 6.07404200127348303794860839843750000, & 
        & -493.915304773088012422834123883928656, & 
        & 7109.51430248936372143881661551339400, & 
        & -41192.6549688975512981414794921875116, & 
        & 122200.464983017459787704326488353593, & 
        & -203400.177280415534278165819877132624, & 
        & 192547.001232531532359057820219398369, & 
        & -96980.5983886375134885659373122090632, & 
        & 20204.2913309661486434512369400435532, & 
        & 24.3805296995560638606548309326171906, & 
        & -2499.83048181120962412519888444380370, & 
        & 45218.7689813627262732812336512974421, & 
        & -331645.172484563577831501052493140906, & 
        & 1268365.27332162478162596623102823909, & 
        & -2813563.22658653411070786835561890978, & 
        & 3763271.29765640399640210562227630261, & 
        & -2998015.91853810675009134620305442043, & 
        & 1311763.61466297720067607155833232793, & 
        & -242919.187900551333458531770061542151, & 
        & 110.017140269246738171204924583435071, & 
        & -13886.0897537170405319722538644617284, & 
        & 308186.404612662398480390784277102097, & 
        & -2785618.12808645468895944456259409650, & 
        & 13288767.1664218183294374116316989638, & 
        & -37567176.6607633513081631979640619223, & 
        & 66344512.2747290266647987984543283892, & 
        & -74105148.2115326577483356209644147043, & 
        & 50952602.4926646422063818219804991871, & 
        & -19706819.1184322269268233898462426119, & 
        & 3284469.85307203782113723164104043477, & 
        & 551.335896122020585607970133423805335, & 
        & -84005.4336030240852886782812566815808, & 
        & 2243768.17792244942923073778023981351, & 
        & -24474062.7257387284678130081560158670, & 
        & 142062907.797533095185653278517916273, & 
        & -495889784.275030309254636245374258466, & 
        & 1106842816.82301446825966666909624588, & 
        & -1621080552.10833707524817588263676894, & 
        & 1553596899.57058005615812104438799628, & 
        & -939462359.681578402546244300920389172, & 
        & 325573074.185765749020228086418133103, & 
        & -49329253.6645099619727618312754747148, & 
        & 3038.09051092238426861058542272076090, & 
        & -549842.327572288687134901932937295149, & 
        & 17395107.5539781645381043963142367452, & 
        & -225105661.889415277804071426963053034, & 
        & 1559279864.87925751334964620474195193, & 
        & -6563293792.61928433203501685097471321, & 
        & 17954213731.1556000801522058538280378, & 
        & -33026599749.8007231400909926757785454, & 
        & 41280185579.7539739551314710270974340, & 
        & -34632043388.1587779229024133355955142, & 
        & 18688207509.2958249223659193027916268, & 
        & -5866481492.05184722761070078443583040, & 
        & 814789096.118312114945930664504976467]

    km=12
    DO l=1,0,-1
       v0 = v-l
       cws = SQRT(1.0_EP-(z/v0)*(z/v0))
       ceta = cws+LOG(z/v0/(1.0_EP+cws))
       ct = 1.0_EP/cws
       ct2 = ct*ct
       DO k=1,km
          l0 = k*(k+1)/2+1
          lf = l0+k
          cf(k) = a(lf)
          DO i=lf-1,l0,-1
             cf(k) = cf(k)*ct2 + a(i)
          END DO
          cf(k) = cf(k)*ct**k
       END DO
       vr = 1.0_EP/v0
       csj = (1.0_EP,0.0_EP)
       DO k=1,km
          csj = csj + cf(k)*vr**k
       END DO
       cbjv = SQRT(ct/(2.0_EP*PIEP*v0))*EXP(v0*ceta-abs(aimag(z)))*csj
       csy = (1.0_EP,0.0_EP)
       DO k=1,km
          csy = csy + (-1)**k*cf(k)*vr**k
       END DO
       cbyv = -SQRT(2.0_EP*ct/(PIEP*v0))*EXP(-v0*ceta-abs(aimag(z)))*csy
    END DO
  END SUBROUTINE cjy

end module complex_bessel
